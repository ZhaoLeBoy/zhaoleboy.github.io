I"ñr<p><a href="!https://baike.baidu.com/item/Doug%20Lea/6319404?fr=aladdin">Doug Lea</a> å¤§å¸ˆå†™çš„ã€ŠScalable IO in Javaã€‹</p>

<p>æ–‡ç« åœ°å€:<a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf">ã€ŠScalable IO in Javaã€‹</a></p>

<p>æˆ‘å°±å½“è¾¹å­¦å˜ç¿»è¯‘æ–‡ç« äº†ï¼Œæ°´å¹³æ¸£ï¼Œå¦‚æœ‰é”™è¯¯å®šå½“æ”¹ä¹‹ã€‚ğŸ˜‚</p>

<hr />

<h3 id="ç½‘ç»œæœåŠ¡">ç½‘ç»œæœåŠ¡</h3>
<p>åœ¨å¤§éƒ¨åˆ†çš„ç½‘ç»œæœåŠ¡ç³»ç»Ÿä¸­(ä¾‹å¦‚.webæœåŠ¡ï¼Œåˆ†å¸ƒå¼å¯¹è±¡)åŸºç¡€ç»“æ„ï¼Œå¦‚ä¸‹:</p>
<ul>
  <li>è¯»è¯·æ±‚</li>
  <li>å¯¹è¯·æ±‚è¿›è¡Œè§£ç </li>
  <li>å¤„ç†ä¸šåŠ¡é€»è¾‘</li>
  <li>å¯¹å¤„ç†å®Œå¯¹ç»“æœè¿›è¡Œç¼–ç </li>
  <li>å‘é€å“åº”</li>
</ul>

<p>ä½†ä¸åŒç½‘ç»œæœåŠ¡å¯¹äºä¸Šé¢çš„æ¯ä¸€æ­¥çš„å¤„ç†çš„æ–¹å¼å’Œæˆæœ¬å¤§éƒ½ä¸ä¸€æ ·ã€‚</p>

<h3 id="ä¼ ç»Ÿçš„æœåŠ¡è®¾è®¡">ä¼ ç»Ÿçš„æœåŠ¡è®¾è®¡</h3>
<p><img src="/img/netty/scalable-io/scalable-io-1.jpg" alt="IMAGE" />
æ¯ä¸ªå¤„ç†å™¨(handler)éƒ½ä¼šåœ¨è‡ªå·±çº¿ç¨‹ä¸­è¿›è¡Œã€‚</p>

<blockquote>
  <p>ç¤ºä¾‹ä»£ç </p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Server</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
<span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="no">PORT</span><span class="o">);</span><span class="c1">//ç»‘å®šæœåŠ¡ç«¯å£å·</span>
      <span class="k">while</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
        <span class="cm">/**
        *å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯å°±ä¼šnewä¸ªçº¿ç¨‹ï¼Œç”±è¿™ä¸ªçº¿ç¨‹è·Ÿå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®åŒå‘å¤„ç†
        *ServerSocketè¿”å›ä¸ªsocket(å µå¡)ä½œä¸ºå‚æ•°ä¼ å…¥å¤„ç†å™¨ï¼Œ
        */</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Handler</span><span class="o">(</span><span class="n">ss</span><span class="o">.</span><span class="na">accept</span><span class="o">())).</span><span class="na">start</span><span class="o">();</span>
      <span class="c1">// or, single-threaded, or a thread pool</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>
    <span class="nc">Handler</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//è·å–è¾“å…¥æµï¼Œè¯»å–å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œæ•°æ®å¤„ç†æœ€åå†™å…¥è¾“å‡ºæµ</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="no">MAX_INPUT</span><span class="o">];</span> 
        <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">().</span><span class="na">read</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">output</span> <span class="o">=</span> <span class="n">process</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">process</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="nl">Note:</span> <span class="n">most</span> <span class="n">exception</span> <span class="n">handling</span> <span class="n">elided</span> <span class="n">from</span> <span class="n">code</span> <span class="n">examples</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ä¼ ç»ŸæœåŠ¡è®¾è®¡å­˜åœ¨çš„ä¸è¶³">ä¼ ç»ŸæœåŠ¡è®¾è®¡å­˜åœ¨çš„ä¸è¶³</h3>
<p>å¦‚æœåªæ˜¯å°‘é‡çš„è¿æ¥æ•°ï¼Œä¼ ç»Ÿæ¨¡å‹æ˜¯å¯ä»¥åº”ä»˜çš„ï¼Œä½†æ˜¯å¦‚ä»Šçš„äº’è”ç½‘éƒ½æ˜¯å‡ åä¸‡åˆ°ç™¾ä¸‡çš„æµé‡ï¼Œè¿æ¥æ•°è‚¯å®šä¹Ÿæ˜¯æˆç™¾ä¸Šåƒï¼Œç‰©ç†æœºæœ‰çº¿ç¨‹æ•°çš„é™åˆ¶ï¼Œçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¹Ÿå¾ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„è®¾è®¡è‚¯å®šæ˜¯é©¾é©­ä¸äº†çš„ã€‚æ‰€ä»¥è¦å¯¹åŸæœ‰çš„æ¨¡å‹è¿›è¡Œæ‰©å±•ã€‚å¸Œæœ›è¾¾åˆ°ä¸€ä¸ªç›®æ ‡ã€‚</p>

<h3 id="å¯ä»¥æ‰©å±•çš„ç›®æ ‡">å¯ä»¥æ‰©å±•çš„ç›®æ ‡</h3>
<ul>
  <li>æ›´å¤šçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œè´Ÿè½½å¢åŠ æ—¶çš„ä¼˜é›…é™çº§ã€‚</li>
  <li>éšç€èµ„æº(CPUã€å†…å­˜ã€ç£ç›˜ã€å¸¦å®½)çš„å¢åŠ ç³»ç»Ÿæ€§èƒ½ä¹Ÿéšä¹‹æé«˜ã€‚</li>
  <li>è¿˜è¦æ»¡è¶³å¯ç”¨æ€§å’Œæ€§èƒ½ç›®æ ‡:
    <ul>
      <li>å»¶è¿Ÿä½</li>
      <li>é«˜è´Ÿè½½</li>
      <li>æœåŠ¡çš„è´¨é‡å¯æ§</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>åˆ†æ²»ç­–ç•¥é€šå¸¸æ˜¯å®ç°å¯ä¼¸ç¼©æ€§ç›®æ ‡çš„æœ€ä½³æ–¹æ³•ã€‚</p>
</blockquote>

<h3 id="åˆ†æ²»ç­–ç•¥divide-and-conquer">åˆ†æ²»ç­–ç•¥(Divide and Conquer)</h3>
<ul>
  <li>å°†å¤„ç†è¿‡ç¨‹åˆ†è§£æ›´å°çš„ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åœ¨ä¸é˜»å¡æƒ…å†µä¸‹æ‰§è¡Œä¸€ä¸ªactionã€‚</li>
  <li>æ‰§è¡Œå¯ç”¨çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼ŒæŸä¸ªä»»åŠ¡ioæ“ä½œæ²¡æœ‰å®Œæˆç³»ç»Ÿä¸å¿…ç­‰å¾…ï¼Œå»æ‰§è¡Œä¸‹ä¸ªå¯ç”¨çš„ä»»åŠ¡ï¼ŒIOäº‹ä»¶ä½œä¸ºè§¦å‘å™¨ä½¿ç”¨ï¼ŒæŸä¸ªIOäº‹ä»¶äº§ç”Ÿï¼Œå¯¹åº”çš„è¯»çš„åŠŸèƒ½å°±ä¼šè¢«è§¦å‘æ‰§è¡Œã€‚</li>
  <li>java.nioä¸­æ”¯æŒçš„åŸºæœ¬æœºåˆ¶ï¼š
    <ul>
      <li>éå µå¡çš„è¯»å†™ã€‚</li>
      <li>åˆ†æ´¾æ„ŸçŸ¥åˆ°IOäº‹ä»¶ç›¸å…³çš„ä»»åŠ¡ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="äº‹ä»¶é©±åŠ¨è®¾è®¡">äº‹ä»¶é©±åŠ¨è®¾è®¡</h3>

<p><strong>è¿™ç§è®¾è®¡æ–¹å¼æ¯”å…¶ä»–æ–¹æ¡ˆæ›´æœ‰æ•ˆ</strong></p>
<ul>
  <li>å ç”¨æ›´å°‘çš„èµ„æºï¼Œä¸ç”¨ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯å¼€å¯æ–°çº¿ç¨‹ã€‚</li>
  <li>æ›´å°çš„å¼€é”€ï¼Œå°‘äº†çº¿ç¨‹å°±å°‘äº†çº¿ç¨‹ç›´æ¥çš„åˆ‡æ¢ï¼Œä¹Ÿå°±å°‘äº†é”çš„ä½¿ç”¨ã€‚</li>
  <li>æ´¾å‘å°†ä¼šå˜å¾—æ…¢ï¼Œå› ä¸ºå¿…é¡»æ‰‹åŠ¨å°†æ“ä½œ(action)ç»‘å®šåˆ°äº‹ä»¶ã€‚</li>
</ul>

<p><strong>ä½†æ˜¯è¿™ç§è®¾è®¡ç¼–ç¨‹æ›´åŠ å¤æ‚</strong></p>
<ul>
  <li>å¿…é¡»æ‹†åˆ†ä¸ºç®€å•çš„éé˜»å¡æ“ä½œ(action),ä¸è¿‡æ— æ³•æ¶ˆé™¤æ‰€æœ‰é˜»å¡ï¼ˆä¾‹å¦‚ï¼Œgcï¼Œé¡µé¢é”™è¯¯ç­‰ï¼‰ã€‚</li>
  <li>å¿…é¡»æŒç»­çš„è·Ÿè¸ªæœåŠ¡çš„é€»è¾‘çŠ¶æ€ã€‚</li>
</ul>

<h3 id="reactoræ¨¡å¼">Reactoræ¨¡å¼</h3>
<ul>
  <li>æ„Ÿåº”å™¨(Reactor)ï¼Œç›¸åº”IOäº‹ä»¶ï¼Œå¹¶æ´¾å‘é€‚å½“çš„å¤„ç†å™¨(handler)è¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</li>
  <li>å¤„ç†å™¨(Handler)ç”¨æ¥å¤„ç†éå µå¡çš„æ“ä½œ(action)ã€‚</li>
  <li>å°†handlerç»‘å®šåˆ°å¯¹åº”äº‹ä»¶ä¸Šè¿›è¡Œç®¡ç†ï¼Œå½“æœ‰äº‹ä»¶äº§ç”Ÿï¼Œä¼šæœ‰ç›¸åº”çš„handlerè¿›è¡Œå¯¹åº”å¤„ç†ã€‚</li>
</ul>

<blockquote>
  <p>å•çº¿ç¨‹ç‰ˆæœ¬</p>
</blockquote>

<p><img src="/img/netty/scalable-io/scalable-io-2.jpg" alt="IMAGE" /></p>

<p>reactoræ˜¯ä¸ªçº¿ç¨‹å¯¹è±¡ç”¨æ¥ç›‘å¬å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·çš„è¿æ¥ã€‚
å½“æœ‰å®¢æˆ·ç«¯æœ‰äº‹ä»¶ä¼ å…¥ï¼ŒReactoræ£€æµ‹åˆ°ååˆ†å‘(dispatch)ç»™ç‰¹å®šçš„å¤„ç†å™¨æ¥å¤„ç†å®¢æˆ·ç«¯æ•°æ®ã€‚</p>

<h3 id="javanioæ”¯æŒ">java.nioæ”¯æŒ</h3>
<p>Chnnels:è¿æ¥åˆ°æ”¯æŒéé˜»å¡è¯»å–çš„æ–‡ä»¶ã€å¥—æ¥å­—ç­‰ã€‚
Buffers:ç±»ä¼¼æ•°ç»„å¯¹è±¡å¯ä»¥ç›´æ¥ç”±channelä¸­è¯»å†™ã€‚
Selectors:é€šçŸ¥å“ªäº›Channelæœ‰ioäº‹ä»¶ã€‚
SelectionKeys:é‡Œé¢ç»´æŠ¤è¿™ioäº‹ä»¶çŠ¶æ€å’Œç»‘å®šäº‹ä»¶ã€‚</p>

<blockquote>
  <p>æ–‡ç« ä¸­çš„ç¤ºä¾‹ä»£ç </p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre></td><td class="rouge-code"><pre><span class="c1">//1.Setup</span>
<span class="kd">class</span> <span class="nc">Reactor</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="nc">Selector</span> <span class="n">selector</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">ServerSocketChannel</span> <span class="n">serverSocket</span><span class="o">;</span>
  
  <span class="nc">Reactor</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
    <span class="n">serverSocket</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
    <span class="n">serverSocket</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">));</span>
    <span class="n">serverSocket</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="nc">SelectionKey</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
    <span class="c1">//serverSocketä¸­é™„åŠ ä¸€ä¸ªAcceptoræ–¹æ³•</span>
    <span class="n">sk</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="k">new</span> <span class="nc">Acceptor</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="c1">//2.Dispatch Loop</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  <span class="c1">// normally in a new Thread</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
          <span class="nc">Set</span> <span class="n">selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span> 
          <span class="nc">Iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> 
          <span class="k">while</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span>
            <span class="c1">//ä¸åšä»»ä½•å®¢æˆ·ç«¯å¤„ç†ã€‚å…¨éƒ¨æ´¾å‘ä¸‹å»</span>
             <span class="n">dispatch</span><span class="o">((</span><span class="nc">SelectionKey</span><span class="o">)(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">());</span> 
          <span class="n">selected</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="kt">void</span> <span class="nf">dispatch</span><span class="o">(</span><span class="nc">SelectionKey</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//è·å–attachmentå¯¹è±¡ä¹Ÿå°±æ˜¯åœ¨å‰é¢çš„çš„Acceptor()</span>
    <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Runnable</span><span class="o">)(</span><span class="n">k</span><span class="o">.</span><span class="na">attachment</span><span class="o">());</span> 
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
      <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">//3.Acceptor </span>
  <span class="kd">class</span> <span class="nc">Acceptor</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span> <span class="c1">// inner</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="nc">SocketChannel</span> <span class="n">c</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">new</span> <span class="nf">Handler</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
     <span class="o">}</span>
  <span class="o">}</span> 
<span class="o">}</span>

<span class="c1">//4.Handler setup</span>
<span class="c1">//å»ºç«‹æ³¨å†Œå®¢æˆ·ç«¯socket</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="nc">SocketChannel</span> <span class="n">socket</span><span class="o">;</span>
  <span class="kd">final</span> <span class="nc">SelectionKey</span> <span class="n">sk</span><span class="o">;</span>
  <span class="nc">ByteBuffer</span> <span class="n">input</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">MAXIN</span><span class="o">);</span> 
  <span class="nc">ByteBuffer</span> <span class="n">output</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">MAXOUT</span><span class="o">);</span> 
  <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">READING</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="no">SENDING</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="no">READING</span><span class="o">;</span>
  
  <span class="nc">Handler</span><span class="o">(</span><span class="nc">Selector</span> <span class="n">sel</span><span class="o">,</span> <span class="nc">SocketChannel</span> <span class="n">c</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="n">socket</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="n">c</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="c1">// Optionally try first read now</span>
   <span class="n">sk</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">sel</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span> 
   <span class="n">sk</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> 
   <span class="n">sk</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span> 
   <span class="n">sel</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="kt">boolean</span> <span class="nf">inputIsComplete</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span> 
  <span class="kt">boolean</span> <span class="nf">outputIsComplete</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span> 
  <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">//åŒºåˆ†çŠ¶æ€ï¼Œå¤„ç†ç”¨æˆ·è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span>      <span class="o">(</span><span class="n">state</span> <span class="o">==</span> <span class="no">READING</span><span class="o">)</span> <span class="n">read</span><span class="o">();</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">==</span> <span class="no">SENDING</span><span class="o">)</span> <span class="n">send</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">socket</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">inputIsComplete</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">process</span><span class="o">();</span>
      <span class="n">state</span> <span class="o">=</span> <span class="no">SENDING</span><span class="o">;</span>
      <span class="c1">// Normally also do first write now </span>
      <span class="n">sk</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">);</span>
    <span class="o">}</span> 
  <span class="o">}</span>
 <span class="kt">void</span> <span class="nf">send</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span> 
  <span class="n">socket</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">outputIsComplete</span><span class="o">())</span> 
    <span class="n">sk</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
  <span class="o">}</span> 
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å¤šçº¿ç¨‹çš„è®¾è®¡">å¤šçº¿ç¨‹çš„è®¾è®¡</h3>

<blockquote>
  <p>ç°ä»£è®¡ç®—æœºéƒ½æ˜¯å¤šæ ¸ï¼Œä¸ºäº†æ›´å¥½çš„åº”ç”¨ç°æœ‰èµ„æºï¼Œç­–ç•¥æ€§åœ°æ·»åŠ çº¿ç¨‹ä»¥è·å¾—å¯ä¼¸ç¼©æ€§ã€‚</p>
  <ul>
    <li>1.å¼•å…¥Workerçº¿ç¨‹ï¼ŒReactorsä¼šå¿«é€Ÿçš„è§¦å‘å¤„ç†å™¨ï¼Œä½†æ˜¯å¤„ç†å™¨çš„å¤„ç†é€Ÿåº¦ä¼šæ‹–æ…¢Reactor,å»ºè®®å°†éIOå¤„ç†äº¤ç»™å…¶ä»–çº¿ç¨‹å®Œæˆã€‚</li>
    <li>2.å¤šReactorçº¿ç¨‹å¯ä»¥åšåˆ°è´Ÿè½½å‡è¡¡ï¼Œå‡è¡¡CPUå’ŒIOä¹‹é—´é€Ÿç‡ã€‚</li>
  </ul>
</blockquote>

<h4 id="1-workerçº¿ç¨‹è®¾è®¡">1. workerçº¿ç¨‹è®¾è®¡</h4>
<ul>
  <li>ç§»é™¤éioçš„æ“ä½œï¼ŒåŠ å¿«reactorçº¿ç¨‹</li>
  <li>æ¯”åœ¨äº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸­é‡æ–°è®¡ç®—ç»‘å®šæ›´ç®€å•ï¼Œè¿˜æ˜¯éé˜»å¡è®¡ç®—,æœ‰æœ‰è¶³å¤Ÿçš„å¤„ç†é‡ä»¥è§£å†³è¿‡è½½é—®é¢˜ã€‚</li>
  <li>ä½†æ˜¯å¤„ç†IOè®¡ç®—é‡å æ¯”è¾ƒå›°éš¾ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä¸€å¼€å§‹å°±å°†æ‰€æœ‰çš„è¾“å…¥è¯»è¿›bufferï¼Œå†è¿›è¡Œåç»­æ“ä½œã€‚</li>
  <li>ä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯ï¼Œæ‰€ä»¥æ–¹ä¾¿è°ƒèŠ‚ï¼Œé€šå¸¸éœ€è¦çš„çº¿ç¨‹æ•°è¦è¿œå°äºå®¢æˆ·ç«¯çš„æ•°é‡ã€‚</li>
</ul>

<p><img src="/img/netty/scalable-io/scalable-io-3.jpg" alt="IMAGE" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  <span class="c1">// uses util.concurrent thread pool</span>
  <span class="c1">//å¯ä»¥ä½¿ç”¨javaè‡ªå¸¦çš„çº¿ç¨‹æ± çš„ä¸€äº›å®ä¾‹å¯¹è±¡</span>
  <span class="kd">static</span> <span class="nc">PooledExecutor</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PooledExecutor</span><span class="o">(...);</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PROCESSING</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
  <span class="c1">// ...</span>
  <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// ...</span>
    <span class="n">socket</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">inputIsComplete</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">//è¯»å–å®Œæ¯•è¾“å…¥æµåæ”¾å…¥çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œå¹¶ä¸”æ ‡è®°çŠ¶æ€</span>
      <span class="n">state</span> <span class="o">=</span> <span class="no">PROCESSING</span><span class="o">;</span>
      <span class="n">pool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Processer</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">processAndHandOff</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">process</span><span class="o">();</span>
    <span class="n">state</span> <span class="o">=</span> <span class="no">SENDING</span><span class="o">;</span> <span class="c1">// or rebind attachment</span>
    <span class="c1">//å¤„ç†å†™äº‹ä»¶</span>
    <span class="n">sk</span><span class="o">.</span><span class="na">interest</span><span class="o">(</span><span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">class</span> <span class="nc">Processer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="n">processAndHandOff</span><span class="o">();</span> <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>æ¯ä¸ªä»»åŠ¡éƒ½å¯ä»¥å¯ç”¨ï¼Œè§¦å‘æˆ–è€…è°ƒç”¨ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li>
  <li>å›è°ƒæ¯ä¸ªå¤„ç†å™¨(per-handler)çš„åˆ†æ´¾å™¨(dispatcher)ï¼Œè®¾ç½®çŠ¶æ€ã€é™„ä»¶ç­‰ã€‚</li>
  <li>é˜Ÿåˆ—å¯ä»¥è·¨é˜¶æ®µä¼ é€’ç¼“å†²åŒºã€‚</li>
  <li>æ¯ä¸ªä»»åŠ¡çš„ç»“æœå¯ä»¥ç”¨wait/notifyæˆ–è€…joinè¿›è¡ŒååŒã€‚</li>
</ul>

<h4 id="2å¤šreactorçº¿ç¨‹è®¾è®¡">2.å¤šReactorçº¿ç¨‹è®¾è®¡</h4>
<ul>
  <li>ä½¿ç”¨reactoræ± ã€‚ç”¨äºåŒ¹é…CPUå’ŒIOçš„é€Ÿç‡ã€‚</li>
  <li>å¯ä»¥é™æ€æˆ–è€…åŠ¨æ€æ„é€ ï¼Œæ¯ä¸ªreactoréƒ½æœ‰è‡ªå·±çš„slector thread dispatch loopã€‚</li>
  <li>ä¸»acceptorå‘å…¶ä»–reactoråˆ†é…ã€‚</li>
</ul>

<p><img src="/img/netty/scalable-io/scalable-io-4.jpg" alt="IMAGE" /></p>

<p>ä¸»æ¥æ”¶å™¨è¿›è¡Œå…¶ä»–reactorçš„åˆ†å‘</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nc">Selector</span><span class="o">[]</span> <span class="n">selectors</span><span class="o">;</span> <span class="c1">// also create threads int next = 0;</span>
<span class="kd">class</span> <span class="nc">Acceptor</span> <span class="o">{</span> <span class="c1">// ...</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span>
    <span class="nc">Socket</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span> 
    <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
      <span class="k">new</span> <span class="nf">Handler</span><span class="o">(</span><span class="n">selectors</span><span class="o">[</span><span class="n">next</span><span class="o">],</span> <span class="n">connection</span><span class="o">);</span> 
      <span class="k">if</span> <span class="o">(++</span><span class="n">next</span> <span class="o">==</span> <span class="n">selectors</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> 
        <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span> 
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ä½¿ç”¨å…¶ä»–nioçš„ç‰¹æ€§">ä½¿ç”¨å…¶ä»–nioçš„ç‰¹æ€§</h3>
<ul>
  <li>æ¯ä¸ªReactoréƒ½æœ‰å¤šä¸ªselectorï¼Œå»ç»‘å®šä¸åŒå¤„ç†å™¨åˆ°ä¸åŒioäº‹ä»¶ä¸­ï¼Œéœ€è¦è€ƒè™‘åˆ°åŒæ­¥å»åè°ƒã€‚</li>
  <li>æ–‡ä»¶åˆ°ç½‘ç»œï¼Œç½‘ç»œåˆ°æ–‡ä»¶çš„è‡ªåŠ¨åŒ–æ‹·è´ã€‚</li>
  <li>ä½¿ç”¨bufferè®¿é—®æ–‡ä»¶ã€‚</li>
  <li>ä½¿ç”¨ç›´æ¥ç¼“å†²åŒº(Direct buffers)å¯ä»¥å®ç°é›¶æ‹·è´,ä½†æ˜¯æœ‰åˆå§‹åŒ–å’Œå›æ”¶å¼€é”€,æœ€é€‚åˆé•¿è¿æ¥çš„åº”ç”¨ç¨‹åºã€‚</li>
</ul>
:ET